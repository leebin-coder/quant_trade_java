version: '3.8'

services:
  # Nacos Service Registry and Config Center
  nacos:
    image: nacos/nacos-server:v3.1.0
    container_name: quant-nacos
    platform: linux/amd64
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
      SPRING_DATASOURCE_PLATFORM: postgresql
      SPRING_DATASOURCE_URL: jdbc:postgresql://quant_postgres:5432/nacos_config
      SPRING_DATASOURCE_USERNAME: libin
      SPRING_DATASOURCE_PASSWORD: libin122351
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      # Nacos 3.x Authentication
      NACOS_AUTH_ENABLE: "true"
      NACOS_AUTH_TOKEN: VGhpc0lzTXlDdXN0b21TZWNyZXRLZXkwMTIzNDU2Nzg5QUJDREVGNDg5Nzg5Nzg5Nzg5Nzg5Nzg5Nzg5
      NACOS_AUTH_IDENTITY_KEY: nacos
      NACOS_AUTH_IDENTITY_VALUE: nacos
      # JVM Options
      JVM_XMS: 512m
      JVM_XMX: 512m
      # Set console port to 8888 to avoid conflict with Gateway 8080
      JAVA_OPT_EXT: "-Dnacos.console.port=8888"
    ports:
      - "8848:8848"
      - "9848:9848"
      - "8888:8888"
    networks:
      - quant-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: quant-gateway/Dockerfile
    container_name: quant-gateway
    ports:
      - "8080:8080"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: on-failure

  # User Service
  user-service:
    build:
      context: .
      dockerfile: quant-user/Dockerfile
    container_name: quant-user
    ports:
      - "8081:8081"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: quant_postgres
      DB_PORT: 5432
      DB_NAME: quant_trade
      DB_USERNAME: libin
      DB_PASSWORD: libin122351
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Trade Service
  trade-service:
    build:
      context: .
      dockerfile: quant-trade/Dockerfile
    container_name: quant-trade
    ports:
      - "8082:8082"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: quant_postgres
      DB_PORT: 5432
      DB_NAME: quant_trade
      DB_USERNAME: libin
      DB_PASSWORD: libin122351
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Risk Service
  risk-service:
    build:
      context: .
      dockerfile: quant-risk/Dockerfile
    container_name: quant-risk
    ports:
      - "8083:8083"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: quant_postgres
      DB_PORT: 5432
      DB_NAME: quant_trade
      DB_USERNAME: libin
      DB_PASSWORD: libin122351
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Market Service
  market-service:
    build:
      context: .
      dockerfile: quant-market/Dockerfile
    container_name: quant-market
    ports:
      - "8084:8084"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: quant_postgres
      DB_PORT: 5432
      DB_NAME: quant_trade
      DB_USERNAME: libin
      DB_PASSWORD: libin122351
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Strategy Service
  strategy-service:
    build:
      context: .
      dockerfile: quant-strategy/Dockerfile
    container_name: quant-strategy
    ports:
      - "8085:8085"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: quant_postgres
      DB_PORT: 5432
      DB_NAME: quant_trade
      DB_USERNAME: libin
      DB_PASSWORD: libin122351
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

networks:
  quant-network:
    external: true
