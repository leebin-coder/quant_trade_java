version: '3.8'

services:
  # Nacos Service Registry and Config Center
  nacos:
    image: nacos/nacos-server:v2.3.2-slim
    container_name: quant-nacos
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
      SPRING_DATASOURCE_PLATFORM: postgresql
      NACOS_DATABASE_HOST: ${DB_HOST:-host.docker.internal}
      NACOS_DATABASE_PORT: ${DB_PORT:-5432}
      NACOS_DATABASE_NAME: ${NACOS_DB_NAME:-nacos_config}
      NACOS_DATABASE_USER: ${DB_USERNAME:-postgres}
      NACOS_DATABASE_PASSWORD: ${DB_PASSWORD:-postgres}
      JVM_XMS: 512m
      JVM_XMX: 512m
    ports:
      - "8848:8848"
      - "9848:9848"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - quant-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8848/nacos/"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # API Gateway
  gateway:
    build:
      context: .
      dockerfile: quant-gateway/Dockerfile
    container_name: quant-gateway
    ports:
      - "8080:8080"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: on-failure

  # User Service
  user-service:
    build:
      context: .
      dockerfile: quant-user/Dockerfile
    container_name: quant-user
    ports:
      - "8081:8081"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-quant_trade}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Trade Service
  trade-service:
    build:
      context: .
      dockerfile: quant-trade/Dockerfile
    container_name: quant-trade
    ports:
      - "8082:8082"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-quant_trade}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Risk Service
  risk-service:
    build:
      context: .
      dockerfile: quant-risk/Dockerfile
    container_name: quant-risk
    ports:
      - "8083:8083"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-quant_trade}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Market Service
  market-service:
    build:
      context: .
      dockerfile: quant-market/Dockerfile
    container_name: quant-market
    ports:
      - "8084:8084"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-quant_trade}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

  # Strategy Service
  strategy-service:
    build:
      context: .
      dockerfile: quant-strategy/Dockerfile
    container_name: quant-strategy
    ports:
      - "8085:8085"
    environment:
      NACOS_SERVER: nacos:8848
      NACOS_NAMESPACE: public
      DB_HOST: ${DB_HOST:-host.docker.internal}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-quant_trade}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      JAVA_OPTS: "-Xms512m -Xmx1024m"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      nacos:
        condition: service_healthy
    networks:
      - quant-network
    restart: unless-stopped

volumes:

networks:
  quant-network:
    driver: bridge
